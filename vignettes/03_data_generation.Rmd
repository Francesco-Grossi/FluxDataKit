---
title: "Data generation"
author: "Koen Hufkens"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data generation}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r include=FALSE}
library(dplyr)
library(FluxDataKit)
library(FluxnetLSM)
library(FluxnetEO)
```

# Compiling data

As mentioned in the introduction (once all required data are downloaded) the
`FluxDataKit` package ensures the proper compilation of `rsofun` driver data.
Although we will distribute a finished dataset the below instructions allow you
to recreate these data for a particular site (or sites).

To generate consistent data from FLUXNET formatted sources we need a site list
with some additional meta-data. A site list is generated using the script as 
described in the 'data coverage' vignette. We refer to this vignette to compile
the list of sites which can be processed.

Once a site list has been compiled you can use it (and all the other input data)
to generated either land surface model or `rsofun` compatible datasets. Here,
the former is used as a precursor to the latter.

## LSM formatting

By default land surface model compatible data is generated using the FluxnetLSM
package. Retaining only this data can be done by specifying the `format`
parameter, and setting it to "lsm". This routine will only save the netcdf
intermediates that are otherwise used for formatting p-model compatible data
and will not include any other ancillary data.

> Meta-data requirements: Note that the sites file can be generated by other means than the included
script. It only has to contain the following values: A site name (`sitename`),
latitude and longitude (`lat`, `lon`), elevation (`elv`), the start and end date of the
dataset (`date_start` / `date_end`), the original product and data path (`product` and
`data_path` respectivelly, which are combined into the formal data directory), a
start and end year (`year_start`, `year_end`), the Koeppen Geiger code for a site
(`koeppen_code_beck`), the water holding capacity (`whc`), and the IGBP land cover
class (`igbp_land_use`). Routines specified in the processing scripts are there
to make it easy to gather these data but users are free to compile additional
data for their own use. The above fields are however required.

```{r eval = FALSE}
# load the sites to process
# as generated from scripts in `data-raw` (see github repo)
sites <- FluxDataKit::fdk_site_info |>
  filter(
    sitename == "US-Wi7"
  ) |>
  mutate(
    data_path = system.file("extdata", package = "FluxDataKit"),
    product = "fluxnet2015"
  )

# output LSM formatted data
fdk_process_lsm(
  sites,
  out_path = tempdir(),
  modis_path = system.file("extdata/modis", package = "FluxDataKit"),
  format = "lsm",
  overwrite = TRUE
)

# list generated files
list.files(tempdir(),"*.nc", recursive = TRUE)
```

## FLUXNET formatting

By default the format parameter is set to "lsm", providing land surface model
netcdf files as output. You can specify "fluxnet" to convert the data to
`rsofun` compatible FLXUNET output.

```{r eval = FALSE}
# read in demo data
# for AT-Neu site (as LSM data)
# convert to the HH fluxnet format
fluxnet <- fdk_convert_lsm(
  site = "AT-Neu",
  path = "/your/input/directory/",
  fluxnet_format = TRUE,
  meta_data = FALSE,
  out_path = "/your/output/directory/"
)

# in line processing doing the same
fdk_process_lsm(
  sites,
  out_path = "/your/output/directory/",
  format = "fluxnet",
  overwrite = TRUE
  )
```

### Plotting conversion results

You can plot conversion results to quickly inspect the results. Here we retain
the data in its original FLUXNET formatting and output the gapfilled and amended
data as a data frame. This data frame is input to the plotting routine
`fdk_plot`, which returns an overview plot to the specified `out_path` directory.

```{r eval = FALSE}
# Read in and convert the data
df <- fdk_convert_lsm(
  site = "AT-Neu",
  path = "/your/input/directory/",
  fluxnet_format = TRUE
  )

# plot the returned data frame
fdk_plot(
  df,
  site = site,
  out_path = "/data/scratch/fluxnet_plots/",
  overwrite = TRUE
)
```

## Conversion to LSM data

The conversion to Land Surface Model data in a netcdf format follows the same
procedure as above using different arguments. In particular you use the `format`
argument set to `lsm` to convert from FLUXNET (FLUX + ERA) files to the netcdf
based datasets compatible with the PLUMBER-2 dataset.

The procedure follows the same gap filling procedures as the PLUMBER-2 dataset,
as well as amending the data with LAI and FPAR data for modelling purposes.

```{r eval = FALSE}
# process all sites
fdk_process_lsm(
  sites,
  out_path = "/your/input/directory",
  modis_path = "/your/input/modis",
  format = "lsm",
  overwrite = FALSE
)
```

## Conversions to daily FLUXNET data (downsampling)

Fluxnet data processed to netcdf files can be converted back to FLUXNET CSV
based files, with the same column naming conventions as the original files. Data
however is downsampled to a daily time step, and additional variables and gap
filling is retained from the above LSM based product.

It must be noted that the these daily products, although adhering to the FLUXNET
naming conventions (both in filename and column names), are not equivalent to the
data generated by the OneFlux processing pipeline.

```{r eval = FALSE}
fdk_downsample_fluxnet(
  df,
  site = site, # a site name
  out_path = "/tmp/"
)
```

## p-model (rsofun) and Machine Learning formatting

In addition, MODIS data can be merged from the FluxnetEO dataset using
the R package [with the same name](https://github.com/computationales/FluxnetEO). 
The latter ensures that rsofun driver (and target) data are ammended with MODIS
data for, among others, machine learning projects.

```{r eval = FALSE}
# read in demo data
# for AT-Neu site (as LSM data)
# convert to the HH fluxnet format
fluxnet <- fdk_convert_lsm(
  site = "AT-Neu",
  path = "/your/input/directory/",
  fluxnet_format = TRUE,
  meta_data = FALSE,
  out_path = "/your/output/directory/"
)

# processing of the half hourly data to
# p-model input drivers for rsofun
rsofun_data <- fdk_format_drivers(
  site_info = sites,
  path = "/your/output/directory/",
  verbose = TRUE
)
```
